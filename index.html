<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çš„ AI æ™ºæ…§è¡£æ«¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --safe-bottom: env(safe-area-inset-bottom); }
        body { -webkit-tap-highlight-color: transparent; padding-bottom: calc(80px + var(--safe-bottom)); font-family: -apple-system, sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .active-nav { color: #4f46e5; border-top: 3px solid #4f46e5; }
        .filter-active { background: #4f46e5 !important; color: white !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b px-6 pt-12 pb-4 flex justify-between items-end">
        <div>
            <h1 class="text-2xl font-black text-indigo-600 tracking-tight">AI CLOSET</h1>
            <div id="weatherDisplay" class="text-[11px] font-bold text-slate-400 mt-1 flex items-center gap-1">
                <i class="fas fa-location-dot"></i> æ­£åœ¨åµæ¸¬å¤©æ°£...
            </div>
        </div>
        <div class="flex gap-4 pb-1 text-slate-400">
            <button onclick="exportData()"><i class="fas fa-file-export"></i></button>
            <button onclick="document.getElementById('importFile').click()"><i class="fas fa-file-import"></i></button>
            <input type="file" id="importFile" class="hidden" onchange="importData(event)">
        </div>
    </header>

    <main class="p-4">
        <section id="wardrobeSection" class="tab-content active">
            <div class="flex gap-2 overflow-x-auto no-scrollbar mb-4 pb-2" id="catBar"></div>
            <div id="grid" class="grid grid-cols-2 gap-4"></div>
            <div id="emptyMsg" class="hidden text-center py-20 text-slate-300">è¡£æ«¥è£¡é‚„æ²’æœ‰è¡£æœå–”ï¼</div>
        </section>

        <section id="outfitSection" class="tab-content">
            <div class="bg-indigo-600 rounded-[32px] p-6 text-white mb-6 shadow-xl relative overflow-hidden">
                <div class="relative z-10">
                    <h3 class="font-bold text-lg mb-1">ä»Šæ—¥ç©¿æ­ AI å»ºè­°</h3>
                    <p id="weatherAdvice" class="text-xs opacity-80 mb-5">è®€å–æ°£æº«ä¸­...</p>
                    <div class="space-y-3">
                        <input type="text" id="moodInput" placeholder="è¼¸å…¥é—œéµå­— (å¦‚ï¼šé»‘è‰²ã€ç´„æœƒ)" class="w-full bg-white/20 border border-white/20 rounded-2xl py-3 px-4 text-sm placeholder:text-white/40 outline-none">
                        <button onclick="generateAI()" class="w-full bg-white text-indigo-600 font-black py-4 rounded-2xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                            <i class="fas fa-wand-magic-sparkles"></i> éš¨æ©Ÿç”¢ç”Ÿç©¿æ­
                        </button>
                    </div>
                </div>
            </div>
            <div id="aiResult"></div>
        </section>

        <section id="statsSection" class="tab-content">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">ç¸½æŠ•è³‡é‡‘é¡</p>
                    <p id="statPrice" class="text-xl font-black text-indigo-600">$0</p>
                </div>
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">ç¸½ç‰©ä»¶æ•¸é‡</p>
                    <p id="statCount" class="text-xl font-black text-indigo-600">0 ä»¶</p>
                </div>
            </div>
            <h3 class="font-bold mb-4">ğŸ“¢ å»ºè­°æ–·æ¨é›¢ (åŠå¹´æœªç©¿)</h3>
            <div id="cleanup" class="space-y-3"></div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around items-center safe-bottom h-20 z-50 px-4">
        <button onclick="switchTab('wardrobe')" class="nav-btn active-nav flex flex-col items-center gap-1"><i class="fas fa-th-large text-lg"></i><span class="text-[9px] font-bold">è¡£æ«¥</span></button>
        <button onclick="switchTab('outfit')" class="nav-btn flex flex-col items-center gap-1"><i class="fas fa-wand-magic-sparkles text-lg"></i><span class="text-[9px] font-bold">AI ææ¡ˆ</span></button>
        <button onclick="openAdd()" class="bg-indigo-600 text-white w-14 h-14 rounded-full -mt-10 shadow-2xl flex items-center justify-center text-xl border-[6px] border-slate-50 active:scale-90 transition"><i class="fas fa-plus"></i></button>
        <button onclick="switchTab('stats')" class="nav-btn flex flex-col items-center gap-1"><i class="fas fa-chart-line text-lg"></i><span class="text-[9px] font-bold">åˆ†æ</span></button>
    </nav>

    <div id="itemModal" class="fixed inset-0 bg-black/70 z-[60] hidden flex items-end">
        <div class="bg-white w-full rounded-t-[40px] p-8 animate-slide-up max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-xl font-black">æ–°å¢è¡£ç‰©</h2>
                <button onclick="closeModal()" class="text-slate-300 text-3xl">&times;</button>
            </div>
            
            <div class="space-y-5">
                <div class="flex gap-4">
                    <div class="w-28 h-28 bg-slate-50 rounded-3xl relative overflow-hidden flex items-center justify-center border-2 border-dashed border-slate-200">
                        <i class="fas fa-camera text-slate-300 text-2xl"></i>
                        <input type="file" id="itemImg" accept="image/*" class="absolute inset-0 opacity-0" onchange="previewImg(this)">
                        <img id="preview" class="absolute inset-0 w-full h-full object-cover hidden">
                    </div>
                    <div class="flex-1 space-y-2">
                        <input type="text" id="itemName" placeholder="ä¾‹å¦‚ï¼šç™½è‰² T-shirt" class="w-full bg-slate-50 p-3 rounded-xl outline-none">
                        <select id="itemCat" class="w-full bg-slate-50 p-3 rounded-xl outline-none"></select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="itemPrice" placeholder="è³¼è²·åƒ¹æ ¼" class="bg-slate-50 p-3 rounded-xl outline-none">
                    <input type="date" id="itemDate" class="bg-slate-50 p-3 rounded-xl outline-none">
                </div>
                <div class="pt-4 flex gap-3">
                    <button id="delBtn" onclick="deleteItem()" class="bg-red-50 text-red-500 w-14 h-14 rounded-2xl hidden"><i class="fas fa-trash"></i></button>
                    <button onclick="saveItem()" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg">ç¢ºèªå­˜å…¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let state = JSON.parse(localStorage.getItem('wardrobe_v5')) || { items: [], cats: ["ä¸Šè¡£", "ä¸‹è‘—", "å¤–å¥—", "é‹å­", "é…ä»¶"] };
        let currentFilter = "å…¨éƒ¨";
        let editingId = null;
        let weather = { temp: 25 };

        window.onload = () => { detectWeather(); render(); };

        async function detectWeather() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`);
                        const data = await res.json();
                        weather.temp = data.current_weather.temperature;
                        document.getElementById('weatherDisplay').innerHTML = `<i class="fas fa-temperature-low"></i> ç•¶å‰æ°£æº« ${weather.temp}Â°C`;
                        updateAdvice();
                    } catch (e) { document.getElementById('weatherDisplay').innerText = "ç„¡æ³•è®€å–å¤©æ°£"; }
                });
            }
        }

        function updateAdvice() {
            const el = document.getElementById('weatherAdvice');
            if(weather.temp < 18) el.innerText = `ç¾åœ¨ ${weather.temp}Â°Cï¼Œå¤©æ°£è¼ƒæ¶¼ï¼ŒAI å»ºè­°æŒ‘é¸å¤–å¥—ã€‚`;
            else el.innerText = `ç¾åœ¨ ${weather.temp}Â°Cï¼Œå¤©æ°£æº«æš–ï¼Œé©åˆè¼•ä¾¿ç©¿æ­ã€‚`;
        }

        function render() {
            renderCatBar();
            renderGrid();
            renderStats();
            localStorage.setItem('wardrobe_v5', JSON.stringify(state));
        }

        function renderCatBar() {
            const bar = document.getElementById('catBar');
            const counts = {};
            state.items.forEach(i => counts[i.cat] = (counts[i.cat] || 0) + 1);
            bar.innerHTML = ["å…¨éƒ¨", ...state.cats].map(c => {
                const num = (c === "å…¨éƒ¨") ? state.items.length : (counts[c] || 0);
                return `<button onclick="setFilter('${c}')" class="${currentFilter===c?'filter-active':'bg-white text-slate-500'} px-5 py-2 rounded-2xl text-[11px] font-black shadow-sm transition">
                    ${c} <span class="opacity-40 ml-1">${num}</span>
                </button>`;
            }).join('');
        }

        function setFilter(f) { currentFilter = f; render(); }

        function renderGrid() {
            const grid = document.getElementById('grid');
            const filtered = state.items.filter(i => currentFilter === "å…¨éƒ¨" || i.cat === currentFilter);
            document.getElementById('emptyMsg').classList.toggle('hidden', filtered.length > 0);
            grid.innerHTML = filtered.map(i => `
                <div onclick="openEdit(${i.id})" class="bg-white rounded-[24px] overflow-hidden shadow-sm border border-slate-100 animate-pop">
                    <img src="${i.img}" class="w-full aspect-square object-cover">
                    <div class="p-3">
                        <p class="text-[9px] font-black text-indigo-500 uppercase">${i.cat}</p>
                        <p class="font-bold text-xs truncate">${i.name}</p>
                    </div>
                </div>
            `).join('');
        }

        function renderStats() {
            const total = state.items.reduce((s, i) => s + (Number(i.price)||0), 0);
            document.getElementById('statPrice').innerText = `$${total.toLocaleString()}`;
            document.getElementById('statCount').innerText = `${state.items.length} ä»¶`;
            const sixMonthsAgo = new Date(); sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            const oldItems = state.items.filter(i => i.date && new Date(i.date) < sixMonthsAgo);
            document.getElementById('cleanup').innerHTML = oldItems.map(i => `
                <div class="flex items-center gap-4 bg-white p-4 rounded-3xl border border-slate-50">
                    <img src="${i.img}" class="w-12 h-12 rounded-2xl object-cover">
                    <div class="flex-1"><p class="text-xs font-bold">${i.name}</p></div>
                    <button onclick="openEdit(${i.id})" class="text-indigo-500 text-xs">æŸ¥çœ‹</button>
                </div>
            `).join('');
        }

        function generateAI() {
            const mood = document.getElementById('moodInput').value.toLowerCase();
            const result = document.getElementById('aiResult');
            let pool = state.items;
            if(mood) pool = pool.filter(i => i.name.toLowerCase().includes(mood) || i.cat.includes(mood));
            const tops = pool.filter(i => i.cat === "ä¸Šè¡£");
            const bottoms = pool.filter(i => i.cat === "ä¸‹è‘—");
            if(tops.length && bottoms.length) {
                const t = tops[Math.floor(Math.random()*tops.length)];
                const b = bottoms[Math.floor(Math.random()*bottoms.length)];
                result.innerHTML = `<div class="bg-white p-6 rounded-[32px] shadow-sm animate-pop flex gap-4">
                    <img src="${t.img}" class="w-1/2 aspect-[3/4] object-cover rounded-2xl">
                    <img src="${b.img}" class="w-1/2 aspect-[3/4] object-cover rounded-2xl">
                </div>`;
            } else {
                result.innerHTML = `<p class="text-center py-10 text-slate-400 text-sm">æ‰¾ä¸åˆ°çµ„åˆï¼Œè«‹å¤šæ–°å¢ä¸€äº›ä¸Šè¡£èˆ‡ä¸‹è‘—ã€‚</p>`;
            }
        }

        function openAdd() {
            editingId = null;
            document.getElementById('modalTitle').innerText = "æ–°å¢å–®å“";
            document.getElementById('itemName').value = "";
            document.getElementById('itemPrice').value = "";
            document.getElementById('preview').classList.add('hidden');
            document.getElementById('delBtn').classList.add('hidden');
            document.getElementById('itemCat').innerHTML = state.cats.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('itemModal').classList.remove('hidden');
        }

        function openEdit(id) {
            editingId = id;
            const item = state.items.find(i => i.id === id);
            document.getElementById('modalTitle').innerText = "ç·¨è¼¯å–®å“";
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemDate').value = item.date;
            document.getElementById('preview').src = item.img;
            document.getElementById('preview').classList.remove('hidden');
            document.getElementById('delBtn').classList.remove('hidden');
            document.getElementById('itemCat').innerHTML = state.cats.map(c => `<option value="${c}" ${c===item.cat?'selected':''}>${c}</option>`).join('');
            document.getElementById('itemModal').classList.remove('hidden');
        }

        function saveItem() {
            const name = document.getElementById('itemName').value;
            const img = document.getElementById('preview').src;
            if(!name || img.includes('camera')) return alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
            const item = {
                id: editingId || Date.now(),
                name, img,
                cat: document.getElementById('itemCat').value,
                price: document.getElementById('itemPrice').value,
                date: document.getElementById('itemDate').value
            };
            if(editingId) state.items = state.items.map(i => i.id === editingId ? item : i);
            else state.items.push(item);
            closeModal(); render();
        }

        function deleteItem() {
            if(confirm('è¦åˆªé™¤é€™ä»¶è¡£æœå—ï¼Ÿ')) {
                state.items = state.items.filter(i => i.id !== editingId);
                closeModal(); render();
            }
        }

        function previewImg(input) {
            const reader = new FileReader();
            reader.onload = e => { 
                document.getElementById('preview').src = e.target.result;
                document.getElementById('preview').classList.remove('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(t + 'Section').classList.add('active');
        }
        function closeModal() { document.getElementById('itemModal').classList.add('hidden'); }
        function exportData() {
            const blob = new Blob([JSON.stringify(state)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'wardrobe.json'; a.click();
        }
        function importData(e) {
            const reader = new FileReader();
            reader.onload = ev => { state = JSON.parse(ev.target.result); render(); alert('è³‡æ–™åŒ¯å…¥å®Œæˆï¼'); };
            reader.readAsText(e.target.files[0]);
        }
    </script>
</body>
</html>
